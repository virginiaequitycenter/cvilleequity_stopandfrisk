---
title: "Charlottesville Police, Temporary Detentions"
output: 
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(leaflet)
library(sf)
library(htmltools)

sf <- readRDS("data/sf_combined.Rds")


sflocations <- read_csv("data/finaldata/sflocations.csv") %>% st_as_sf(
    coords = c("lon", "lat"),
    crs = 4326,
    remove = TRUE
  ) %>%
  filter(!Year %in% c(2019, 2020))

beats <- readRDS("beat_pop_map.Rds")


```

Overall {data-orientation=rows}
===================================== 

Row
-----------------------------------------------------------------------

### Average Detentions per Month 

```{r}
avg <- round(nrow(sf)/44,1)
valueBox(avg, icon = "fa-hand-paper")
```

### Percent of Detentions with Search or Frisk
```{r}
frisk <- round(nrow(filter(sf, type == "STOP WITH SEARCH OR FRISK")) /
                 nrow(sf)*100, 0)
valueBox(frisk, icon = "fa-search")
```

### Ratio of Black to White Citizens Detained 

```{r}
sf_race <- sf %>% 
  filter(race %in% c("B", "W")) %>% 
  mutate(race = factor(race),
         race = fct_recode(race, 
                           Black = "B",
                           White = "W"))


ratio <- round(nrow(filter(sf_race, race == "Black")) / nrow(filter(sf_race, race == "White")),1)
valueBox(ratio, icon = "fa-user-friends")
```

Row
-----------------------------------------------------------------------

### About the Data {data-width=333}

This analysis is based on data received from FOIA requests (attribution for requesting?) over multiple time periods:

* Period 1: July 2012-June 2014, with data for only part of the first and last month
* Period 2: January 2016-October 2016 and January 2017-December 2017

Considerably more of the detentions involved a stop and frisk search in the second period. The disproportionate interaction of Black residents remains consistently high in both periods.

The following pages provide additional analysis,

* Composition compares the percent of Black and White detentions to the overall population in the city.
* Geography visualizes where Black and White citizens are detained by the police.
* Offenses shows the nature of the offense reported as the reason for the detention across Black and White residents.

### Detentions, with and without Search/Frisk, by Race

```{r}
ggplot(sf_race, aes(x = type, fill = fct_rev(race))) + 
  geom_bar() + facet_wrap(~period)
```


Composition {data-orientation=rows}
===================================== 

Row
-----------------------------------------------------------------------

### Detentions per 1000 population for Black residents (2-year period)
```{r}
bl_pc <- round(((nrow(filter(sf_race, race == "Black"))/2) / 8782)*1000,1)
valueBox(bl_pc, icon = "fa-minus-square")
```

### Detentions per 1000 population for White residents (2-year period)
```{r}
wh_pc <- round(((nrow(filter(sf_race, race == "White"))/2) / 32565)*1000,1)
valueBox(wh_pc, icon = "fa-plus-square")
```


Row
-----------------------------------------------------------------------

### Detentions Relative to Population

```{r}
pop <- data.frame("race" = c("White", "Black", "Asian", "Multiracial", "Remaining"), 
                  "value" = c(32565, 8782, 3370, 1443, 327))

pop <- pop %>% 
  mutate(race = factor(race, levels = c("Black", "White", "Multiracial", "Asian", "Remaining")),
         group = "pop")

pop3 <- pop %>% 
  mutate(race = fct_collapse(race, 
                             Remainig = c("Multiracial", "Asian", "Remaining"))) %>% 
  group_by(race) %>% 
  summarize(value = sum(value)) %>% 
  ungroup() %>% mutate(group = "pop")

pop2 <- pop3 %>% 
  filter(race %in% c("Black", "White")) %>% 
  droplevels()


# total by race
sf_race_all <- sf_race %>% 
  group_by(race) %>% 
  summarize(value = n()) %>% 
  ungroup() %>% 
  mutate(group = "total")

sf_race_all <- rbind(sf_race_all, pop2) %>% 
  mutate(group = factor(group, levels = c("pop", "total")))

ggplot(sf_race_all, aes(x = group, y = value, fill = race)) + 
  geom_bar(position="fill", stat="identity") + 
  coord_polar("y")
```


Mapping {data-orientation=row}
===================================== 
Will use the iframe tag here to add in the shiny map

``` {r}
``` {r}
l <-NULL

beats_data <- 
beats  %>% 
  mutate(`Percent White` = round(whitepopE/totalpopE*100,2),
         `Percent Black` = round(blackpopE/totalpopE*100,2)
        ) 

colorswhite <- colorRampPalette(brewer.pal(9, "Greens"))(9)[2:6]
whitepal <- colorBin(palette = colorswhite, domain = c(0,100), bins = 5)

colorsblack<- colorRampPalette(brewer.pal(9, "Purples"))(9)[2:6]
blackpal <- colorBin(palette = colorsblack, domain = c(0,100), bins = 5)

race.beats <- list(`Percent White` = beats_data %>% mutate(color = `Percent White`, df = "Percent White"),
     `Percent Black` = beats_data %>% mutate(color = `Percent Black`, df = "Percent Black")
     )

beatscolorfunction <- function(listname, color){
  ifelse( listname == names(race.beats)[1],  whitepal(color), blackpal(color)  )
}

l <- leaflet() %>%
  addProviderTiles("Stamen.Toner")  

names(race.beats) %>%
   purrr::walk( function(df) {
    l <<- l %>%
           addPolygons(
              data = race.beats[[df]],
              weight = 3,
              fillOpacity = .5,
              color = ~beatscolorfunction(df, color),
              group = df
            )
    })


## Add Race Dot Colors ## 
race.df <- split(sflocations, sflocations$RACE)
race.colors <- data.frame()

mycolors <- c("#001855", "#002D00")
racelevels <- names(race.df)
racepal <- colorFactor(palette = mycolors,
                   domain = racelevels)

names(race.df) %>%
   purrr::walk( function(df) {
    l <<- l %>%
          addCircleMarkers(
                data = race.df[[df]],
                color = ~racepal(df),
                  weight = 0,

                radius = 3,
               fillOpacity = 1,
               group = df,
#               label = ~htmlEscape(paste0(RACE, "<br>",SFTYPE,"<br>", OFFENSE))
     label = ~htmlEscape(paste0(RACE, "\n",SFTYPE,"\n", OFFENSE))
       )
    })
  
l %>%
  addLayersControl(
    baseGroups =  names(race.beats),
    overlayGroups = names(race.df),
    options = layersControlOptions(collapsed = FALSE)
  )


 # l <- leaflet(data = beats) %>%
 #  addProviderTiles("Stamen.Toner")  %>%
 #  addPolygons(
 #    weight = 1,
 #    fillOpacity = .1
 #  ) #%>%
 #  addCircleMarkers(
 #    data = df,
 #    color = "red",
 #    weight = 0,
 #    radius = 2,
 #    fillOpacity = .5,
 #    label = ~htmlEscape(paste0(RACE, "\n",SFTYPE,"\n", OFFENSE))
 #  )


```


```


Offense {data-orientation=rows}
===================================== 

```{r}
sf_race <- sf_race %>% 
  mutate(offense7 = case_when(
    str_detect(offense, "Assault|Robbery|PURSE|Shots|Weapon") ~ "Person Crime",
    str_detect(offense, "Burglary|Larceny|Trespass|VANDAL") ~ "Property Crime",
    str_detect(offense, "Narcotic") ~ "Narcotics Related",
    str_detect(offense, "Traffic") ~ "Traffic Related",
    str_detect(offense, "Disorder|Drunk|Liquor|INDECENT|DIP") ~ "Public Disorder",
    str_detect(offense, "Suspicious|Supsicious") ~ "Suspicious Circumstance",
    TRUE ~ "Other"
  ))

sf_race <- sf_race %>% 
  mutate(offense7 = factor(offense7),
         offense7 = fct_infreq(offense7))

ggplot(sf_race, aes(x = fct_rev(offense7), fill = fct_rev(race))) + 
  geom_bar() + coord_flip() + facet_wrap(~period, ncol = 1)
```
