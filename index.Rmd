---
title: "Charlottesville Police, Temporary Detentions"
output:
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    theme: bootstrap
    logo: image/UVAEQUITYCENTER.jpeg
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(leaflet)
library(sf)
library(htmltools)
library(RColorBrewer)

# I am demonstrating github


sf <- readRDS("data/sf_combined.Rds")


sflocations <- read_csv("data/sflocations.csv") %>% st_as_sf(
    coords = c("lon", "lat"),
    crs = 4326,
    remove = TRUE
  ) %>%
  filter(!Year %in% c(2019, 2020))

beats <- readRDS("data/beat_pop_map.Rds")


```

Introduction {data-orientation=rows}
=====================================

Row
-----------------------------------------------------------------------

### Average Detentions per Month

```{r Detentions per Month}
avg <- round(nrow(sf)/56,1) #Enrique added 12 months to denominator
valueBox(avg, icon = "fa-hand-paper")
```

### Percent of Detentions with Search or Frisk
```{r Detentions with Search or Frisk}
frisk <- round(nrow(filter(sf, type == "STOP WITH SEARCH OR FRISK")) /
                 nrow(sf)*100, 0)
valueBox(frisk, icon = "fa-search")
```

### Ratio of Black to White Citizens Detained

```{r Black to White Citizens}
sf_race <- sf %>%
  filter(race %in% c("B", "W")) %>%
  mutate(race = factor(race),
         race = fct_recode(race,
                           Black = "B",
                           White = "W"),
         race = fct_relevel(race, "White"),
         type2 = factor(type),
         type2 = fct_recode(type2,
                            "Search/Frisk" = "STOP WITH SEARCH OR FRISK",
                            "No Search/Frisk" = "Search WITHOUT Stop-Frisk"))


pal2 <- c("#8dd3c7" ,"#bebada")

ratio <- round(nrow(filter(sf_race, race == "Black")) / nrow(filter(sf_race, race == "White")),1)
valueBox(ratio, icon = "fa-user-friends")
```

Row
-----------------------------------------------------------------------

### About the Data {data-width=333}

A temporary detention involves a police officer holding and questioning an individual for a short amount of time. The police only need *reasonable suspicion* for a temporary detention. Detentions may be accompanied by some form of search or frisk, though not all detentions involve a search. Detentions can be dispatched in response to a call or initiated by an officer.

This analysis is based on records of temporary detentions made by the City of Charlottesville Police. The data was received in response to Freedom of Information Act requests by Jeff Fogel made over multiple time periods. We have aggregated the data to two primary time periods:

* Period 1: mid-July 2012 to mid-June 2014
* Period 2: January 2016 to mid-October 2016 combined with January 2017-December 2017

Navigate to additional pages for further analysis:

* **Who?** compares the percent of Black and White detentions to the overall population in the city.
* **Where?** visualizes where Black and White citizens are detained by the police.
* **Why?** shows the reason recorded by the police for the detention across Black and White residents.


### Detentions, with and without Search/Frisk, by Race

```{r Detentions by Race}
# for annotation
tots <- sf_race %>% group_by(year, type2) %>% summarize(tots = n())
racetots <- sf_race %>% group_by(year, type2, race) %>% summarize(racetot = n())
racetots <- racetots %>% left_join(tots)
racetots <- racetots %>% mutate(percent = round((racetot/tots)*100,0),
                                percent_lab = paste0(percent, "%"),
                                race = fct_relevel(race, "White")) %>%
  group_by(year, type2) %>%
  arrange(year, type2, race) %>%
  mutate(lab_height =  racetot/2)


ggplot(sf_race, aes(x = type2, fill = race)) +
  geom_bar(position = "dodge") + facet_wrap(~year) +
  scale_fill_manual(values = pal2) +
  labs(fill = "Race") +
  theme(axis.title = element_blank()) +
  geom_text(data = arrange(racetots, race), aes(x = type2, y = lab_height, fill = race, label = percent_lab), position = position_dodge(width = .85), size = 3, hjust = .5) +
  geom_text(data = arrange(racetots, race), aes(x = type2, y = racetot + 8, fill = race, label = racetot), position = position_dodge(width = .85), size = 4, hjust = .5)

```



Who? {data-orientation=rows}
=====================================

Row
-----------------------------------------------------------------------

### Detentions per 1000 population for Black residents (2-year period)
```{r per 1000}
bl_pc <- round(((nrow(filter(sf_race, race == "Black"))/2) / 8782)*1000,1)
valueBox(bl_pc, icon = "fa-users")
```


### Detentions per 1000 population for White residents (2-year period)
```{r}
wh_pc <- round(((nrow(filter(sf_race, race == "White"))/2) / 32565)*1000,1)
valueBox(wh_pc, icon = "fa-user")
```


Row {.tabset}
-----------------------------------------------------------------------

```{r}
pop <- data.frame("race" = c("White", "Black", "Asian", "Multiracial", "Remaining"),
                  "value" = c(32565, 8782, 3370, 1443, 327))

pop <- pop %>%
  mutate(race = factor(race, levels = c("Black", "White", "Multiracial", "Asian", "Remaining")),
         group = "pop")

pop3 <- pop %>%
  mutate(race = fct_collapse(race,
                             Remaining = c("Multiracial", "Asian", "Remaining"))) %>%
  group_by(race) %>%
  summarize(value = sum(value)) %>%
  ungroup() %>% mutate(group = "pop")

pop2 <- pop3 %>%
  filter(race %in% c("Black", "White")) %>%
  droplevels()
```

### Detentions Relative to Population

```{r}
# total by race
sf_race_all <- sf_race %>%
  group_by(race) %>%
  summarize(value = n()) %>%
  ungroup() %>%
  mutate(group = "total")

sf_race_all <- rbind(sf_race_all, pop2) %>%
  mutate(group = factor(group, levels = c("pop", "total")),
         race = fct_relevel(race, "White")) %>%
  arrange(group, desc(race)) %>%
  group_by(group) %>%
  mutate(label_pos = (cumsum(value) - value/2)/sum(value), 
         percent = paste0(round(value/sum(value)*100,1),"%")
         )

labellingdata <- data.frame(label = c("Population", "Detentions"), group = c("pop", "total"), pos = c(.90,.90) )


ggplot(sf_race_all, aes(x = group, y = value, fill = race)) +
  geom_bar(position="fill", stat="identity") +
  scale_fill_manual(values = pal2, name = "Race") +
  coord_polar("y", direction = 1) +
  scale_x_discrete(limits = c(" ", "pop","total")) +
  theme_void() +
  geom_text(  data = filter(sf_race_all, race == "Black"), aes(x = group, y = label_pos, label = percent), size = 3) +
  geom_text( data = labellingdata,
             aes(x = group, y = pos, label = label) ,inherit.aes = FALSE, size = 3) 

```

> Population estimates are from the 5-year [American Community Survey 2013-2017](https://data.census.gov/cedsci/table?q=b02001&g=0500000US51540&hidePreview=false&tid=ACSDT5Y2017.B02001&vintage=2017&layer=VT_2017_050_00_PY_D1&cid=B02001_001E&y=2017) estimates, to overlap with the time period of the detention data; population percents are based on only the Black and White populations of Charlottesville to align with data on race available in the detention data.

### By Year 

```{r By Year}
sf_race_year <- sf_race %>%
  group_by(year, race) %>%
  summarize(value = n()) %>%
  ungroup() %>%
  mutate(group = "")

pop2_p1 <- pop2 %>%
  mutate(period = "2012-2014")
pop2_p2 <- pop2 %>%
  mutate(period = "2016-2017")

pop2_year <- pop2 %>%
  mutate(year = "Total")

sf_race_year <- rbind(sf_race_year, pop2_year) %>%
  mutate(group = c(c(rep("year",12), rep("pop",2))),
         race = fct_relevel(race, "White"))%>%
  arrange(group, year, desc(race)) %>%
  group_by(group, year) %>%
  mutate(label_pos = (cumsum(value) - value/2)/sum(value), 
         percent = paste0(round(value/sum(value)*100,1),"%")
         )

sf_race_period <- rbind(sf_race_period, pop2_p1, pop2_p2) %>%
  mutate(group = factor(group, levels = c("pop", "period")),
         race = fct_relevel(race, "White")) %>%
  arrange(group, period, desc(race)) %>%
  group_by(group, period) %>%
  mutate(label_pos = (cumsum(value) - value/2)/sum(value), 
         percent = paste0(round(value/sum(value)*100,1),"%")
         )

labellingdata <- data.frame (label = c(rep("Population",6), rep("Detentions",6)), 
  group = c(rep("pop",6), rep("year",6)), pos = rep(.90, 12), year = rep(seq(2012,2017),2))



ggplot(sf_race_year, aes(x = year, y = value, fill = race)) +
  geom_bar(position="fill", stat = "identity") +
  scale_fill_manual(values = pal2, name = "Race") +
  coord_polar("y", direction = 1)  +
  scale_x_discrete(limits = c(" ", "Total",seq(2012,2017))) +
  theme_void() +
  geom_text(data = filter(sf_race_year, race == "Black"), 
            aes(x = year, y = label_pos, label = percent), 
            size = 3) +
  facet_wrap(~ year) +
  geom_text(data = labellingdata,
            aes(x = year, y = pos, label = label),
            inherit.aes = FALSE, size = 3)
 
```

### By Stop and Frisk

```{r}
sf_race_type <- sf_race %>%
  group_by(type2, race) %>%
  summarize(value = n()) %>%
  ungroup() %>%
  mutate(group = "type") %>%
  rename(type = type2)

pop2_t1 <- pop2 %>%
  mutate(type = "No Search/Frisk")
pop2_t2 <- pop2 %>%
  mutate(type = "Search/Frisk")

sf_race_type <- rbind(sf_race_type, pop2_t1, pop2_t2) %>%
  mutate(group = factor(group, levels = c("pop", "type")),
         race = fct_relevel(race, "White")) %>%
  arrange(group, type, desc(race)) %>%
  group_by(group, type) %>%
  mutate(label_pos = (cumsum(value) - value/2)/sum(value), 
         percent = paste0(round(value/sum(value)*100,1),"%")) 

labellingdata <- data.frame(label = rep(c("Population", "Detentions"),2), group = rep(c("pop", "type"),2), pos = rep(c(.90,.90),2), type = rep(c("No Search/Frisk", "Search/Frisk"), each = 2 ))

ggplot(sf_race_type, aes(x = group, y = value, fill = race)) +
  geom_bar(position="fill", stat = "identity") +
  scale_fill_manual(values = pal2, name = "Race") +
  coord_polar("y", direction = 1) +
  scale_x_discrete(limits = c(" ", "pop","type")) +
  geom_text(  data = filter(sf_race_type, race == "Black"), aes(x = group, y = label_pos, label = percent), size = 3) +
    geom_text( data = labellingdata,
             aes(x = group, y = pos, label = label) ,inherit.aes = FALSE, size = 3) +
  theme_void() +
  facet_wrap(~type) 
```




Where? {data-orientation=rows}
===================================== 

### Where Do Police Detain People?

#### Map Details
* These maps display police detentions from both time periods, *2012-2014* and *2016-2017*. 
* Each point represents one individual stopped.
* Points *do not* represent the exact locations of each stop, but the density of the dots represents the density of detainments in a [geographic area](https://opendata.charlottesville.org/datasets/police-neighborhood-area).
* To help guide your eyes, detentions that include Search and Frisk are circled in red.
* Turn on and off underlying population characteristics through the box on the right
* Note that the underlying population percentages are based on a comparison of White and Black populations only to align with the races identifiable in the police data files.  

Row {data-height=700}
----------------------------------------------

### Detentions 2012 - 2014 & 2016 - 2017 

``` {r fig.width = 7 }

l <-NULL

beats_data <- 
beats  %>% 
  mutate(`Percent White` = round(whitepopE/totalpopE*100,2),
         `Percent Black` = round(blackpopE/totalpopE*100,2)
        ) 

colorswhite <- colorRampPalette(brewer.pal(9, "Greens"))(9)[2:6]
whitepal <- colorBin(palette = colorswhite, domain = c(0,100), bins = 5)

colorsblack<- colorRampPalette(brewer.pal(9, "Purples"))(9)[2:6]
blackpal <- colorBin(palette = colorsblack, domain = c(0,100), bins = 5)

race.beats <- list(
      `Data Off` = beats_data %>% mutate(color = 0, df = "Data Off"),
     `Percent White` = beats_data %>% mutate(color = `Percent White`, df = "Percent White"),
     `Percent Black` = beats_data %>% mutate(color = `Percent Black`, df = "Percent Black")
     )

beatscolorfunction <- function(listname, color){
case_when(
     listname == names(race.beats)[2] ~   whitepal(color),
     listname == names(race.beats)[3] ~   blackpal(color),
     TRUE ~ "DCF0EF"
    )
}

beatsopacityfunction <- function(listname){
case_when(
     listname == names(race.beats)[2] ~   .5,
     listname == names(race.beats)[3] ~  .5,
     TRUE ~ 0.01
    )
}

l <- leaflet() %>%
  addProviderTiles("Stamen.Toner",
                   options = providerTileOptions(minZoom = 13))   %>%
  addMapPane("polygons", zIndex = 410) %>%
  addMapPane("circlemarkers", zIndex = 420) 


names(race.beats) %>%
   purrr::walk( function(df) {
    l <<- l %>%
           addPolygons(
              data = race.beats[[df]],
              weight = 3,
              fillOpacity = ~beatsopacityfunction(df),
              color = ~beatscolorfunction(df, color),
              group = df   ,
                            smoothFactor = 0.5,
              label = ~htmlEscape(paste0(NAME,  ifelse(color == 0, "", ifelse(df  == "Percent White", paste0(": ", color, "% White"), paste0(": ", color, "% Black") )  )))
              )
    })

## Add Race Dot Colors ## 

sflocationsmap <- 
  sflocations %>%
  mutate(RACE = ifelse(RACE == "W", "White", "Black"))
  
race.df <- split(sflocationsmap, sflocationsmap$RACE)
race.colors <- data.frame()

mycolors <- c("#6969B3", "#00AF98")
racelevels <- names(race.df)
racepal <- colorFactor(palette = mycolors,
                   domain = racelevels)

names(race.df) %>%
   purrr::walk( function(df) {
    l <<- l %>%
          addCircleMarkers(
                data = race.df[[df]],
                color = ~racepal(df),
                weight = 0,
                radius = 2.5,
               fillOpacity = 1,
               group = df,
          label = ~htmlEscape(paste0("Offense: ", OFFENSE))

)
       
    })
  
sf.df <- split(sflocationsmap, sflocationsmap$SFTYPE)
sf.race.df   <- split(sf.df[["STOP WITH SEARCH OR FRISK"]], sf.df[["STOP WITH SEARCH OR FRISK"]]$RACE)

names(sf.race.df) %>%
   purrr::walk( function(df) {
    l <<- l %>%
          addCircleMarkers(
                data = sf.race.df[[df]],
                color =  "red",
                weight = 1,
                radius = 6,
                fill = FALSE,
               group = df
       )
    })
    
html_legend <- "<svg width = '10' height = '10'> <circle cx='5' cy='5' r='5' stroke='red' fill = 'white' stroke-width = '1' /></svg> = Stop & Frisk"
               
l %>%
  addLayersControl(
    baseGroups =  names(race.beats),
    overlayGroups =  c(names(race.df)),
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  htmlwidgets::onRender("
    function(el, x) {
      this.on('baselayerchange', function(e) {
        e.layer.bringToBack();
      })
    }") %>%
    addLegend("bottomleft", pal = racepal, values = names(race.df),
    title = "Race",
    opacity = 1
  ) %>%
    addControl(html = html_legend, position = "bottomright")



```

### Detentions by Beat
 
``` {r fig.height = 5, fig.width = 7}
 
sfs <- 
  sflocations %>%
  mutate(RACE = ifelse(RACE == "W", "White", "Black")) %>%
  as_tibble() %>% 
  select(BEAT_NO, RACE, OFFENSE, SFTYPE) %>%
  left_join(
  beats %>%
    as_tibble() %>%
    select(BEAT_NO, NAME) %>%
    mutate(BEAT_NO = as.numeric(BEAT_NO))
) %>%
  group_by(NAME, BEAT_NO, RACE, SFTYPE) %>%
  summarize(Counts = n()) %>%
    group_by(NAME) %>%
  mutate(total = sum(Counts)) %>%
  mutate(Counts = ifelse(RACE ==  "Black", Counts *-1, Counts)) %>%
  ungroup() %>%
  mutate(RACE = fct_relevel(RACE, "White")) %>%
  group_by(NAME, RACE) %>%
  mutate(RaceTot = sum(Counts)) %>%
  mutate(lab_pos = ifelse(RACE ==  "Black", RaceTot -2, RaceTot + 2))

pal2 <- c("#8dd3c7" ,"#bebada")

ggplot(sfs, aes(x = reorder(NAME, -total), fill = RACE, y = Counts, alpha = SFTYPE), color = "black") +
  geom_bar(stat = "identity") + labs(fill = "Race") +
  scale_fill_manual(values = pal2) +
  geom_text(data = sfs %>% select(NAME, lab_pos, RaceTot) %>% unique(), aes(x = NAME, y = lab_pos, label = abs(RaceTot)), size = 3, inherit.aes = FALSE) +
  coord_flip() +
  scale_y_continuous(labels = function(x){abs(x)}, limits = c(-60, 60), breaks = c(seq(-40, 40, 20), 0)) +
  scale_alpha_discrete(range = c(.6, 1)) +
  annotate("text", x = 29, y = -15, label = "Black" ) +
    annotate("text", x = 29, y = 15, label = "White" ) +
   annotate("rect", xmin = 25, xmax = 26, ymin = 10, ymax = 14, alpha = 1, fill = "#8dd3c7") +
   annotate("text", x = 25.5, y = 15, label = "= With Stop and Frisk", size = 3, hjust = 0)+
    annotate("rect", xmin = 23.5, xmax = 24.5, ymin = 10, ymax = 14, alpha = .6, fill = "#8dd3c7") +
   annotate("text", x = 24, y = 15, label = "= Without Stop and Frisk", size = 3, hjust = 0)+
  geom_hline(yintercept  = 0) +
  theme_minimal() +
  theme(
    legend.position = "none",
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    axis.title = element_blank(),
    panel.grid.major.y = element_line(linetype = "dashed"),
 #   axis.text.x = element_blank(),
 axis.line.x = element_line(),
 axis.ticks.x = element_line()

  ) 


```

Row 
----------------------------------------------
### Changes Over Time 
Trends:

* Greater dispersion of stop and frisk throughout the city during the 2017
* Noticeable *decrease* of stop and frisk in the Rose Hill nieghborhood.
* Stop and frisk of black individuals in areas with predominantly student housing *increased*, specifically in the Grady, Rugby Road, and Emmet Street Areas in addition to the areas south of west main by the train tracks and Jefferson Park Avenue.
* Stop and Frisk *increased significantly*, particularly for black individuals, in the Prospect/Orangedale Ave area. 


Row 
----------------------------------------------

### 2012-2014 
``` {r }

l <-NULL

beats_data <- 
beats  %>% 
  mutate(`Percent White` = round(whitepopE/totalpopE*100,2),
         `Percent Black` = round(blackpopE/totalpopE*100,2)
        ) 

colorswhite <- colorRampPalette(brewer.pal(9, "Greens"))(9)[2:6]
whitepal <- colorBin(palette = colorswhite, domain = c(0,100), bins = 5)

colorsblack<- colorRampPalette(brewer.pal(9, "Purples"))(9)[2:6]
blackpal <- colorBin(palette = colorsblack, domain = c(0,100), bins = 5)

race.beats <- list(
      `Data Off` = beats_data %>% mutate(color = 0, df = "Data Off"),
     `Percent White` = beats_data %>% mutate(color = `Percent White`, df = "Percent White"),
     `Percent Black` = beats_data %>% mutate(color = `Percent Black`, df = "Percent Black")
     )

beatscolorfunction <- function(listname, color){
case_when(
     listname == names(race.beats)[2] ~   whitepal(color),
     listname == names(race.beats)[3] ~   blackpal(color),
     TRUE ~ "DCF0EF"
    )
}

beatsopacityfunction <- function(listname){
case_when(
     listname == names(race.beats)[2] ~   .5,
     listname == names(race.beats)[3] ~  .5,
     TRUE ~ .01
    )
}


l <- leaflet() %>%
  addProviderTiles("Stamen.Toner",
                   options = providerTileOptions(minZoom = 13))   %>%
  addMapPane("polygons", zIndex = 410) %>%
  addMapPane("circlemarkers", zIndex = 420) 

names(race.beats) %>%
   purrr::walk( function(df) {
    l <<- l %>%
           addPolygons(
              data = race.beats[[df]],
              weight = 3,
              fillOpacity = ~beatsopacityfunction(df),
              color = ~beatscolorfunction(df, color),
              group = df   ,
              smoothFactor = 0.5,
              label = ~htmlEscape(paste0(NAME,  ifelse(color == 0, "", ifelse(df  == "Percent White", paste0(": ", color, "% White"), paste0(": ", color, "% Black") )  )))

              )
    })

## Add Race Dot Colors ## 

sflocationsmap <- 
  sflocations %>%
  mutate(RACE = ifelse(RACE == "W", "White", "Black")) %>%
  filter(Year < 2015) %>%
    mutate(labels =  paste0( '<p> Race:', RACE, '<p></p>', 
         SFTYPE, '</p><p> Offense:', 
          OFFENSE, '</p>' ) 
)
  
race.df <- split(sflocationsmap, sflocationsmap$RACE)
race.colors <- data.frame()

mycolors <- c("#6969B3", "#00AF98")
racelevels <- names(race.df)
racepal <- colorFactor(palette = mycolors,
                   domain = racelevels)

names(race.df) %>%
   purrr::walk( function(df) {
    l <<- l %>%
          addCircleMarkers(
                data = race.df[[df]],
                color = ~racepal(df),
                weight = 0,
                radius = 2.5,
               fillOpacity = 1,
               group = df,
               label = ~htmlEscape(paste0("Offense: ", OFFENSE))

       )
    })
  
sf.df <- split(sflocationsmap, sflocationsmap$SFTYPE)
sf.race.df   <- split(sf.df[["STOP WITH SEARCH OR FRISK"]], sf.df[["STOP WITH SEARCH OR FRISK"]]$RACE)

names(sf.race.df) %>%
   purrr::walk( function(df) {
    l <<- l %>%
          addCircleMarkers(
                data = sf.race.df[[df]],
                color =  "red",
                weight = 1,
                radius = 6,
                fill = FALSE,
               group = df
       )
    })
    
               
l %>%
  addLayersControl(
    baseGroups =  names(race.beats),
    overlayGroups =  c(names(race.df)),
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  htmlwidgets::onRender("
    function(el, x) {
      this.on('baselayerchange', function(e) {
        e.layer.bringToBack();
      })
    }") %>%
    addLegend("bottomleft", pal = racepal, values = names(race.df),
    title = "Race",
    opacity = 1
  ) %>%
    addControl(html = html_legend, position = "bottomright")


```

### 2016-2017
``` {r }

l <-NULL

beats_data <- 
beats  %>% 
  mutate(`Percent White` = round(whitepopE/totalpopE*100,2),
         `Percent Black` = round(blackpopE/totalpopE*100,2)
        ) 

colorswhite <- colorRampPalette(brewer.pal(9, "Greens"))(9)[2:6]
whitepal <- colorBin(palette = colorswhite, domain = c(0,100), bins = 5)

colorsblack<- colorRampPalette(brewer.pal(9, "Purples"))(9)[2:6]
blackpal <- colorBin(palette = colorsblack, domain = c(0,100), bins = 5)

race.beats <- list(
      `Data Off` = beats_data %>% mutate(color = 0, df = "Data Off"),
     `Percent White` = beats_data %>% mutate(color = `Percent White`, df = "Percent White"),
     `Percent Black` = beats_data %>% mutate(color = `Percent Black`, df = "Percent Black")
     )

beatscolorfunction <- function(listname, color){
case_when(
     listname == names(race.beats)[2] ~   whitepal(color),
     listname == names(race.beats)[3] ~   blackpal(color),
     TRUE ~ "DCF0EF"
    )
}

beatsopacityfunction <- function(listname){
case_when(
     listname == names(race.beats)[2] ~   .5,
     listname == names(race.beats)[3] ~  .5,
     TRUE ~ 0
    )
}


l <- leaflet() %>%
  addProviderTiles("Stamen.Toner",
                   options = providerTileOptions(minZoom = 13))   %>%
  addMapPane("polygons", zIndex = 410) %>%
  addMapPane("circlemarkers", zIndex = 420) 

names(race.beats) %>%
   purrr::walk( function(df) {
    l <<- l %>%
           addPolygons(
              data = race.beats[[df]],
              weight = 3,
              fillOpacity = ~beatsopacityfunction(df),
              color = ~beatscolorfunction(df, color),
              group = df   ,
             smoothFactor = 0.5,
              label = ~htmlEscape(paste0(NAME,  ifelse(color == 0, "", ifelse(df  == "Percent White", paste0(": ", color, "% White"), paste0(": ", color, "% Black") )  )))
              )
    })

## Add Race Dot Colors ## 

sflocationsmap <- 
  sflocations %>%
  mutate(RACE = ifelse(RACE == "W", "White", "Black")) %>%
  filter(Year > 2015) %>% ##################################################### YEAR 
   mutate(labels =  paste0( '<p> Race:', RACE, '<p></p>', 
         SFTYPE, '</p><p> Offense:', 
          OFFENSE, '</p>' ) 
)
  
race.df <- split(sflocationsmap, sflocationsmap$RACE)
race.colors <- data.frame()

mycolors <- c("#6969B3", "#00AF98")
racelevels <- names(race.df)
racepal <- colorFactor(palette = mycolors,
                   domain = racelevels)

names(race.df) %>%
   purrr::walk( function(df) {
    l <<- l %>%
          addCircleMarkers(
                data = race.df[[df]],
                fillColor = ~racepal(df),
                weight = 0,
                radius = 2.5,
               fillOpacity = 1,
               group = df,
              label = ~htmlEscape(paste0("Offense: ", OFFENSE))

       )
    }) 
  
sf.df <- split(sflocationsmap, sflocationsmap$SFTYPE)
sf.race.df   <- split(sf.df[["STOP WITH SEARCH OR FRISK"]], sf.df[["STOP WITH SEARCH OR FRISK"]]$RACE)

names(sf.race.df) %>%
   purrr::walk( function(df) {
    l <<- l %>%
          addCircleMarkers(
                data = sf.race.df[[df]],
                color =  "red",
                weight = 1,
                radius = 6,
                fill = FALSE,
               group = df
       )
    })
    
               
l %>%
  addLayersControl(
    baseGroups =  names(race.beats),
    overlayGroups =  c(names(race.df)),
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  htmlwidgets::onRender("
    function(el, x) {
      this.on('baselayerchange', function(e) {
        e.layer.bringToBack();
      })
    }")  %>%
    addLegend("bottomleft", pal = racepal, values = names(race.df),
    title = "Race",
    opacity = 1
  ) %>%
    addControl(html = html_legend, position = "bottomright")


```

Row 
----------------------------------------------
### Over Policing & Exclusive Spaces

The data does not record why police enter certain spaces, whether it is an officer-initiated discretionary stop or a response to a call.  We also do not have data on whether or not a detainment led to an arrest. The offense listed is the reason the police officer recorded to justify the stop based on reasonable suspicion, not a determination that the offense occured. Beacuse of this, it is difficult to say that police detainments are an indicator of crime. Fewer detainments does not immediatley signify less crime in an area, just less police activity. 

Below, we highlight three areas, a predominantly black residential space, a predominantly white residential space, and a public walking mall to investigate who police detain and where.

Row {data-height=600}
----------------------------------------------
### Ridge Street & Prospect-Orangedale Neighborhoods {data-height=600}


``` {r}
l <- NULL

beats_data <- 
beats  %>% 
  mutate(`Percent White` = round(whitepopE/totalpopE*100,2),
         `Percent Black` = round(blackpopE/totalpopE*100,2)
        ) 

beatsopacityfunction <- function(BEAT_NO){
case_when(
     BEAT_NO %in% c("12", "21" )  ~ 0,
     TRUE ~ .9
    )
}


l <- leaflet(options = leafletOptions(zoomControl = FALSE)) %>%
  addProviderTiles("Stamen.Toner",
                   options = providerTileOptions(minZoom = 15, maxZoom = 16))   %>%
         setView( lng =  -78.48875, lat = 38.02272 , zoom = 15) %>%

  addMapPane("polygons", zIndex = 410) %>%
  addMapPane("circlemarkers", zIndex = 420) %>%
    # setMaxBounds( lng1 = -87.94011
    #              , lat1 = 41.64454
    #              , lng2 = -87.52414
    #              , lat2 = 42.02304 ) %>%
           addPolygons(
              data = beats_data,
              weight = 10,
              fillOpacity = ~beatsopacityfunction(BEAT_NO),
              color = "grey",
               smoothFactor = 0.5,

              )

## Add Race Dot Colors ## 
sflocationsmap <- 
  sflocations %>%
  mutate(RACE = ifelse(RACE == "W", "White", "Black")) %>%
  filter(BEAT_NO  %in%  c(12, 21 )) 
  
race.df <- split(sflocationsmap, sflocationsmap$RACE)
race.colors <- data.frame()

mycolors <- c("#6969B3", "#00AF98")
racelevels <- names(race.df)
racepal <- colorFactor(palette = mycolors,
                   domain = racelevels)

names(race.df) %>%
   purrr::walk(  function(df) {
    l <<- l %>%
          addCircleMarkers(
                data = race.df[[df]],
                color = ~racepal(df),
                weight = 0,
                radius = 4,
               fillOpacity = 1,
               group = df,
              label = ~htmlEscape(paste0("Offense: ", OFFENSE))
)
    })
  
sf.df <- split(sflocationsmap, sflocationsmap$SFTYPE)
sf.race.df   <- split(sf.df[["STOP WITH SEARCH OR FRISK"]], sf.df[["STOP WITH SEARCH OR FRISK"]]$RACE)

names(sf.race.df) %>%
   purrr::walk( function(df) {
    l <<- l %>%
          addCircleMarkers(
                data = sf.race.df[[df]],
                color =  "red",
                weight = 1,
                radius = 7,
                fill = FALSE,
               group = df
       )
    }) 
               
l %>%
    addLegend("bottomleft", pal = racepal, values = names(race.df),
    title = "Race",
    opacity = 1
  ) %>%
    addControl(html = html_legend, position = "bottomright")


```


### Martha Jefferson & Locust Grove Neighborhoods {data-height=600}

``` {r}
l <- NULL

beats_data <- 
beats  %>% 
  mutate(`Percent White` = round(whitepopE/totalpopE*100,2),
         `Percent Black` = round(blackpopE/totalpopE*100,2)
        ) 

beatsopacityfunction <- function(BEAT_NO){
case_when(
     BEAT_NO %in% c("08", "19" )  ~ 0,
     TRUE ~ .9
    )
}


l <- leaflet(options = leafletOptions(zoomControl = FALSE)) %>%
  addProviderTiles("Stamen.Toner",
                   options = providerTileOptions(minZoom = 15, maxZoom = 16))   %>%
         setView( lng = -78.46738, lat = 38.03754 , zoom = 15) %>%

  addMapPane("polygons", zIndex = 410) %>%
  addMapPane("circlemarkers", zIndex = 420) %>%
    # setMaxBounds( lng1 = -87.94011
    #              , lat1 = 41.64454
    #              , lng2 = -87.52414
    #              , lat2 = 42.02304 ) %>%
           addPolygons(
              data = beats_data,
              weight = 10,
              fillOpacity = ~beatsopacityfunction(BEAT_NO),
              color = "grey",
               smoothFactor = 0.5,

              )

## Add Race Dot Colors ## 
sflocationsmap <- 
  sflocations %>%
  mutate(RACE = ifelse(RACE == "W", "White", "Black")) %>%
  filter(BEAT_NO  %in%  c(8, 19)) 
  
race.df <- split(sflocationsmap, sflocationsmap$RACE)
race.colors <- data.frame()

mycolors <- c("#6969B3", "#00AF98")
racelevels <- names(race.df)
racepal <- colorFactor(palette = mycolors,
                   domain = racelevels)

names(race.df) %>%
   purrr::walk(  function(df) {
    l <<- l %>%
          addCircleMarkers(
                data = race.df[[df]],
                color = ~racepal(df),
                weight = 0,
                radius = 4,
               fillOpacity = 1,
               group = df,
              label = ~htmlEscape(paste0("Offense: ", OFFENSE))
)
    })
  
sf.df <- split(sflocationsmap, sflocationsmap$SFTYPE)
sf.race.df   <- split(sf.df[["STOP WITH SEARCH OR FRISK"]], sf.df[["STOP WITH SEARCH OR FRISK"]]$RACE)

names(sf.race.df) %>%
   purrr::walk( function(df) {
    l <<- l %>%
          addCircleMarkers(
                data = sf.race.df[[df]],
                color =  "red",
                weight = 1,
                radius = 7,
                fill = FALSE,
               group = df
       )
    }) 
               
l %>%
    addLegend("bottomleft", pal = racepal, values = names(race.df),
    title = "Race",
    opacity = 1
  ) %>%
    addControl(html = html_legend, position = "bottomright")


```

Row {data-height=600}
----------------------------------------------

### Downtown {data-width=600}
``` {r}
l <- NULL

beats_data <- 
beats  %>% 
  mutate(`Percent White` = round(whitepopE/totalpopE*100,2),
         `Percent Black` = round(blackpopE/totalpopE*100,2)
        ) 

beatsopacityfunction <- function(BEAT_NO){
case_when(
     BEAT_NO == "01"  ~   0,
     TRUE ~ .9
    )
}

l <- leaflet(options = leafletOptions(zoomControl = FALSE)) %>%
  addProviderTiles("Stamen.Toner",
                   options = providerTileOptions(minZoom = 16, maxZoom = 17))   %>%
         setView( lng = -78.4795, lat = 38.0305, zoom = 16) %>%

  addMapPane("polygons", zIndex = 410) %>%
  addMapPane("circlemarkers", zIndex = 420) %>%
    # setMaxBounds( lng1 = -87.94011
    #              , lat1 = 41.64454
    #              , lng2 = -87.52414
    #              , lat2 = 42.02304 ) %>%
           addPolygons(
              data = beats_data,
              weight = 3,
              fillOpacity = ~beatsopacityfunction(BEAT_NO),
              color = "grey",
               smoothFactor = 0.5,

              )

## Add Race Dot Colors ## 
sflocationsmap <- 
  sflocations %>%
  mutate(RACE = ifelse(RACE == "W", "White", "Black")) %>%
  filter(BEAT_NO == 1) %>%
    mutate(labels =  paste0( '<p> Race:', RACE, '<p></p>', 
         SFTYPE, '</p><p> Offense:', 
          OFFENSE, '</p>' ) 
)
  
race.df <- split(sflocationsmap, sflocationsmap$RACE)
race.colors <- data.frame()

mycolors <- c("#6969B3", "#00AF98")
racelevels <- names(race.df)
racepal <- colorFactor(palette = mycolors,
                   domain = racelevels)

names(race.df) %>%
   purrr::walk(  function(df) {
    l <<- l %>%
          addCircleMarkers(
                data = race.df[[df]],
                color = ~racepal(df),
                weight = 0,
                radius = 4,
               fillOpacity = 1,
               group = df,
              label = ~htmlEscape(paste0("Offense: ", OFFENSE))
)
    })
  
sf.df <- split(sflocationsmap, sflocationsmap$SFTYPE)
sf.race.df   <- split(sf.df[["STOP WITH SEARCH OR FRISK"]], sf.df[["STOP WITH SEARCH OR FRISK"]]$RACE)

names(sf.race.df) %>%
   purrr::walk( function(df) {
    l <<- l %>%
          addCircleMarkers(
                data = sf.race.df[[df]],
                color =  "red",
                weight = 1,
                radius = 7,
                fill = FALSE,
               group = df
       )
    }) 
               
l %>%
    addLegend("bottomleft", pal = racepal, values = names(race.df),
    title = "Race",
    opacity = 1
  ) %>%
    addControl(html = html_legend, position = "bottomright")

sfs %>% filter(BEAT_NO %in% c("8", "19", "21", "12"))

```


### Analysis

Historically, racial covenants prohibited Black individuals from living in the Martha Jefferson and Locust Grove. That legacy continues today

* An estimated 1401 White individuals live in the Martha Jefferson and Locust Grove Neighborhoods
* 3 (2.14 for every 1000) White individuals were detained in the Martha Jefferson and Locust Grove Neighborhoods
* An estimated 1731	Black individuals live in in Prospect Orangedale Ave and Ridge St Neighborhoods
* 68 (39 for every 1000) Black individuals were detained in the Prospect Orangedale Ave and Ridge St Neighborhoods

The Downtown Mall is a public space for free use by Charlottesville residents. 

* In the periods of 2012 -2014 and 2016-2017, 26 Black individuals were detained by police 
* 22 White individuals were detained in the same period. 
* 73% of Black individuals stopped (19 individuals) were also searched and frisked 
* 31% (7) of White individuals were also searched and frisked. 



Why? {data-orientation=rows}
=====================================

### What Reasons do Police Give for Detentions?

Police officers record a reason for detaining an individual. We recoded these reasons into the following categories: (1) Narcotics related, (2) Suspicious circumstances, (3) Disorderly conduct (including drunkeness), (4) Crimes on persons (e.g., assult, robbery, weapons), (5) Crimes on property (e.g., burglary, vandalism, trespassing), (6) Traffic-related (e.g., traffic stops, violations, accidents), and (7) everything else (e.g., assistance, unidentified). While several of the reasons represent categories of crimes, the recorded reason reflects the reasonable suspicion of an officer at the time of the stop, not a conclusion that the given crime has been committed. We do not have a record for whether the stop led to an arrest for all of the data provided.


Row {.tabset}
-----------------------------------------------------------------------

### Detention by Recorded Reason

```{r}
sf_race <- sf_race %>%
  mutate(offense7 = case_when(
    str_detect(offense, "Assault|Robbery|PURSE|Shots|Weapon") ~ "Person Crime",
    str_detect(offense, "Burglary|Larceny|Trespass|VANDAL") ~ "Property Crime",
    str_detect(offense, "Narcotic") ~ "Narcotics Related",
    str_detect(offense, "Traffic") ~ "Traffic Related",
    str_detect(offense, "Disorder|Drunk|Liquor|INDECENT|DIP") ~ "Public Disorder",
    str_detect(offense, "Suspicious|Supsicious") ~ "Suspicious Circumstance",
    TRUE ~ "Other"
  ))

sf_race <- sf_race %>%
  mutate(offense7 = factor(offense7),
         offense7 = fct_infreq(offense7))

# for annotation
tots <- sf_race %>% group_by(offense7) %>% summarize(tots = n())
racetots <- sf_race %>% group_by(offense7, race) %>% summarize(racetot = n())
racetots <- racetots %>% left_join(tots)
racetots <- racetots %>% mutate(percent = round((racetot/tots)*100,0),
                                percent_lab = ifelse(tots < 40 & racetot < 15 ,"",  paste0(percent, "%")),
                                race = fct_relevel(race, "White"),
                                racetot = ifelse(race == "White", racetot*-1, racetot),
                                lab_pos = racetot/2)

ggplot(racetots, aes(x = offense7, fill = race, y = racetot)) +
  geom_bar(stat = "identity") + labs(fill = "Race") +
  scale_fill_manual(values = pal2) +
  geom_text(data = racetots, aes(x = offense7, y = lab_pos, label = percent_lab), size = 2) +
  coord_flip() +
  labs(y = "# Detentions", x = "Reason") +
  scale_y_continuous(labels = function(x){abs(x)}, limits = c(-120, 120))
```


### By Time Period 

```{r fig.height = 8, fig.width = 8}
# for annotation
tots <- sf_race %>% group_by(offense7, period) %>% summarize(tots = n())
racetots <- sf_race %>% group_by(offense7, race, period) %>% summarize(racetot = n())
racetots <- racetots %>% left_join(tots)
racetots <- racetots %>% ungroup() %>% mutate(percent = round((racetot/tots)*100,0),
                                percent_lab = ifelse(tots < 40 & racetot < 10 ,"",  paste0(percent, "%")),
                                race = fct_relevel(race, "White"),
                                racetot = ifelse(race == "White", racetot*-1, racetot),
                                lab_pos = racetot/2)

ggplot(racetots, aes(x = offense7, fill = race, y = racetot)) +
  geom_bar(stat = "identity") + labs(fill = "Race") +
  scale_fill_manual(values = pal2) +
  geom_text(data = racetots, aes(x = offense7, y = lab_pos, label = percent_lab), size = 3) +
  coord_flip() +
  labs(y = "# Detentions", x = "Reason") +
  scale_y_continuous(labels = function(x){abs(x)}, limits = c(-95, 95)) +
  facet_wrap(~period, nrow = 2) 
```


### By Stop and Frisk 

```{r fig.height = 7, fig.width = 8}
tots <- sf_race %>% group_by(offense7, type2) %>% summarize(tots = n())
racetots <- sf_race %>% group_by(offense7, race, type2) %>% summarize(racetot = n())
racetots <- racetots %>% left_join(tots)
racetots <- racetots %>% ungroup() %>% mutate(percent = round((racetot/tots)*100,0),
                                percent_lab = ifelse(tots < 40 & racetot < 10 ,"",  paste0(percent, "%")),
                                race = fct_relevel(race, "White"),
                                racetot = ifelse(race == "White", racetot*-1, racetot),
                                lab_pos = racetot/2)

ggplot(racetots, aes(x = offense7, fill = race, y = racetot)) +
  geom_bar(stat = "identity") + labs(fill = "Race") +
  scale_fill_manual(values = pal2) +
  geom_text(data = racetots, aes(x = offense7, y = lab_pos, label = percent_lab), size = 3) +
  coord_flip() +
  labs(y = "# Detentions", x = "Reason") +
  scale_y_continuous(labels = function(x){abs(x)}, limits = c(-120, 120), breaks = seq(-120,120,20)) +
  facet_wrap(~type2, nrow = 2) 
```

About {data-orientation=rows}
=====================================

The Charlottesville policing data was acquired by attorney Jeff Fogel through Freedom of Information Act requests. The site was created by [Michele Claibourn](https://mclaibourn.github.io/) and Sam Powers in a partnership between the [Equity Center](http://virginiaequitycenter.org/) at UVA and Jordy Yager's *[Determined](https://www.cvilletomorrow.org/articles/determined-stories-of-resilience-in-a-broken-ecosystem/)* series with Vinegar Hill Magazine and Charlottesville Tomorrow. 

This is a work in progress and we plan to keep building and improving it. We appreciate all feedback --  questions, corrections, concerns, ideas to make it better. You can reach us at [CvilleEquityAtlas@virginia.edu](mailto:CvilleEquityAtlas@virginia.edu). The source code to generate the analysis and this site are available on [GitHub](https://github.com/virginiaequitycenter/cvilleequity_stopandfrisk).

### Resources on policing in the Charlottesville community

* 2020 Disproportionate Minority Contact Report (coming soon, we hope)
    + [Charlottesville and Albemarle release report on disproportionate minority contact](https://www.nbc29.com/2020/01/28/charlottesville-albemarle-release-report-disproportionate-minority-contact/), January 28, 2020, NBC29
    + [Report finds racial disparity at almost every level of local criminal justice system](https://www.dailyprogress.com/dailyprogress/report-finds-racial-disparity-at-almost-every-level-of-local-criminal-justice-system/article_8c1dad70-7e3a-565b-a98c-f9bc4a189862.html), January 29, 2020, The Daily Progress
    + [Race-based bias: Consultants demonstrate racist policing, council says study didn’t go far enough](https://www.c-ville.com/race-based-bias-consultants-demonstrate-racist-policing/), February 4, 2020, C-VILLE Weekly
    + [Questions remain in the wake of the disproportionate minority contact report’s release](https://www.cvilletomorrow.org/articles/questions-remain-in-the-wake-of-the-disproportionate-minority-contact-reports-release/), February 7, 2020, Charlottesville Tomorrow
    + [Now that the disproportionate minority contact report has been released, what’s next?](https://www.cvilletomorrow.org/articles/now-that-the-disproportionate-minority-contact-report-has-been-released-whats-next/), February 24, 2020, Charlottesville Tomorrow
* [Charlottesville Police Statistics](https://www.charlottesville.gov/327/Crime-Statistics)
    + We initially hoped to use the information reported in the reports that began Feburary 2019, but the number of monthly cases reported in these reports was four times the number in the earlier FOIA'd data; we chose to pause until we could understand more clearly how data generation process for these new reports differs from the process for the 2012-2017 data.
* News on Charlottesville's Civilian Review Board
    + [Initial and current Civilian Review Board members speak about next steps](https://www.nbc29.com/2020/06/05/initial-current-civilian-review-board-members-speak-about-next-steps/), June 5, 2020, NBC29
    + [Council appoints seven to Police CRB](https://www.dailyprogress.com/news/local/council-appoints-seven-to-police-crb/article_75ff0476-743a-577d-a68e-66a8feac8250.html), February 18, 2020, Daily Progress
* [Disproportionate Minority Contact Task Force](https://www.charlottesville.gov/254/Disproportionate-Minority-Contact-Task-F)
    + [Assessment of Disproportionate Minority Contact in Charlottesville](https://www.charlottesville.gov/DocumentCenter/View/348/DMC-Report-PDF), 2016
    + [Charlottesville Task Force Report on Disproportionate Minority Contactin the Juvenile Justice System](https://www.charlottesville.gov/DocumentCenter/View/347/Final-Full-DMC-Report-PDF), 2014
    + [Race Disparity and Disproportionality in Youth Services](https://www.charlottesville.gov/DocumentCenter/View/350/Disproportionality-Study-PDF), 2011
* Legal Aid Justice Center [Civil Rights & Racial Justice Program](https://www.justice4all.org/civil-rights-racial-justice/)
